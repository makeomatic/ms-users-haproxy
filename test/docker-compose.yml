services:
  consul:
    image: consul:1.6
    hostname: consul
    ports:
      - 8500:8500

  haproxy:
    build:
      context: ${PWD}
    depends_on: 
      - consul
    volumes:
      - ${PWD}/test/config:/usr/local/etc/haproxy
      - ${PWD}/test/keys:/usr/local/etc/haproxy-keys
      - ${PWD}/test/server/tracer.lua:/usr/local/etc/haproxy-tracer.lua
      - ${PWD}/src/verify-jwt.lua:/usr/local/lib/lua/5.3/verify-jwt.lua
      - ${PWD}/src/verify-jwt:/usr/local/lib/lua/5.3/verify-jwt
      - ${PWD}/test/consul-template:/rules
    ports:
      - 8080:8080
      - 8081:8081
  consul-template:
    depends_on:
      - consul
    restart: always
    command: "-log-level debug -consul-addr=consul:8500 -consul-retry -consul-retry-attempts=3 -template=/templates/test.tmpl:/templates/revocation-rules.conf:\"/bin/docker kill -s HUP haproxy-haproxy-1 || true\""
    image: makeomatic/consul-template:0.19.5
    volumes:
      - ${PWD}/test/consul-template:/templates
      - /var/run/docker.sock:/tmp/docker.sock